<section id="roadmap-nav" class="pure-g background-white padding-top-2em padding-bottom-2em ">
    <!-- nav loaded from json -->
</section>
<div class="slopecap-horizontal background-gray"></div>
<section id="roadmap" class="pure-g background-gray padding-top-{{ include.padding-top }} padding-bottom-{{ include.padding-bottom }} ">
    <div id="roadmap-list" class="container-padding roadmap-bottom-line">
        <!-- loaded from json -->
    </div>
</section>
<script>
if (!{{ include.homepage }}) {

    // roadmap 
    $.getJSON("{{ site.roadmapurl }}")
        .done(function(json) {

            buildNav(json.labels)
            buildRoadmap(json)

            // event listener for href change
            $(window).on('hashchange', function(event) {
                let url = window.location.href
                let params = url.split("#")
                params.shift()

                buildRoadmap(json)
            });
        })
        .fail(function(jqxhr, textStatus, error) {
            console.log("Roadmap JSON request Failed: ", textStatus, error);
        });

} else {
    // home page build roadmap only with prioritiy 
    $.getJSON("{{ site.roadmapurl }}")
        .done(function(json) {

            buildRoadmap(json)
        })
        .fail(function(jqxhr, textStatus, error) {
            console.log("Roadmap JSON request Failed: ", textStatus, error);
        });

}

function buildNav(list) {

    var nav = list.map(function(d, i) {
        return ('<a href="roadmap.html#' + d + '" class="roadmap-nav-item" id=><i class="fas fa-tag"></i> ' + d + '</a>')
    }).join('')

    let url = window.location.href
    let params = url.split("#")
    params.shift()

    if(params[0] === undefined){
        params[0] = "Show All"
    }

    $('#roadmap-nav').prepend('<div class="roadmap-nav"><a href="roadmap.html" class="roadmap-nav-item"><i class="fas fa-list"></i> Show All</a>' + nav + ' </div>')

}

function buildRoadmap(json) {

    // get href params
    let url = window.location.href
    let params = url.split("#")
    params.shift()

    // default shows all via "Public"
    let filter = "Public"

    // get filter parameters
    if (params[0] != undefined) {
        filter = params[0]
    }

    // if homepage only priorities 
    if ({{ include.homepage }}) {
        filter = "Priority"
    }

    // FIXME @mike-wendt - temp hack to use existing json layout
    var stable_ver = json.legacy
    var nighlty_ver = json.stable
    var future_ver = json.nightly
    var stable_date = json.legacydate
    var nightly_date = json.stabledate
    var future_date = json.nightlydate
    var stable_epics = json.projects.legacy
    var nightly_epics = json.projects.stable
    var future_epics = json.projects.nightly

    var stable = buildLists(stable_ver, stable_epics, filter)
    var nightly = buildLists(nighlty_ver, nightly_epics, filter)
    var future = buildLists(future_ver, future_epics, filter)

    //clear
    $('#roadmap-list').html("")

    $('#roadmap-list').append('<div class="pure-u-1 pure-u-md-1-3 roadmap-vline"> <div class="roadmap-ver">' + stable_ver + '<div class="roadmap-ver-title"> stable - ' + stable_date + '</div> </div> <ul class="roadmap-list">' + stable + ' </ul></div>')
    $('#roadmap-list').append('<div class="pure-u-1 pure-u-md-1-3 roadmap-vdash"> <div class="roadmap-ver">' + nighlty_ver + '<div class="roadmap-ver-title"> nightly - ' + nightly_date + '</div> </div> <ul class="roadmap-list">' + nightly + ' </ul></div>')
    $('#roadmap-list').append('<div class="pure-u-1 pure-u-md-1-3 roadmap-vdot"> <div class="roadmap-ver"> ON DECK <div class="roadmap-ver-title"> FUTURE RELEASES </div> </div> <ul class="roadmap-list">' + future + ' </ul></div>')


}

function buildLists(ver, data, filter) {
    let list = ''

    if (ver === undefined || data.length === 0) {
        list = '<li><i class="fas fa-ban"></i> Nothing Hilighted </li>'
    } else {
        list = data.map(function(d, i) {

            if (d.labels.includes(filter)) {
                var tags = d.labels.map(function(e, j) {
                    if (e != 'Public') {
                        return ('<a href="roadmap.html#' + e + '" class="roadmap-tag">' + e + '</a>')
                    }
                }).join('')

                return ('<li>' + tags + '<div class="roadmap-list-title">' + d.title + '</div> <p class="roadmap-list-text">' + d.description + '</p></li>')
            }

        }).join('')

    }

    // check for empty list
    if (list == '') {
        list = '<li><p class="roadmap-list-text"><i class="fas fa-ban"></i> No matching items </p></li>'
    } else {
        // add show all link
        list += '<br> <a class="roadmap-link" href="roadmap.html"> <i class="fas fa-list"></i> Show All </a>'
    }
    return list
}
</script>